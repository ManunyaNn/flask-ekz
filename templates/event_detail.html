{% extends "base.html" %}

{% block title %}{{ event.title }}{% endblock %}

{% block content %}
{% set default_image = url_for('static', filename='images/default_event.jpg') %}
<style>
.event-image {
    max-height: 400px;
    object-fit: cover;
    width: 100%;
}
.image-placeholder {
    height: 200px;
    background: linear-gradient(45deg, #f8f9fa, #e9ecef);
    display: flex;
    align-items: center;
    justify-content: center;
    color: #6c757d;
    border: 2px dashed #dee2e6;
}
</style>
<!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏ -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="card-title mb-0">{{ event.title }}</h4>
                    <span class="badge {% if event.registration_status == '–ò–¥—ë—Ç –Ω–∞–±–æ—Ä –≤–æ–ª–æ–Ω—Ç—ë—Ä–æ–≤' %}bg-success{% elif event.registration_status == '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∞' %}bg-warning{% else %}bg-secondary{% endif %}">
                        {{ event.registration_status }}
                    </span>
                </div>
            </div>
            <div class="card-body">
                <!-- –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
                <div class="text-center mb-4">
                    {% if event.image_filename and event.image_filename != 'default_event.jpg' %}
                        <img src="{{ url_for('static', filename='uploads/' + event.image_filename) }}" 
                             alt="{{ event.title }}" 
                             class="event-image rounded"
                             onerror="this.src='{{ default_image }}'; this.alt='–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ'">
                    {% else %}
                        <div class="image-placeholder rounded">
                            <div>
                                <i class="bi bi-image fs-1"></i>
                                <p class="mt-2 mb-0">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</p>
                            </div>
                        </div>
                    {% endif %}
                </div>
                
                <div class="mb-4">
                    <h5>–û–ø–∏—Å–∞–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è:</h5>
                    <div class="event-description border rounded p-3 bg-light">
                        {{ event.description_html|safe }}
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>–î–∞—Ç–∞:</strong> {{ event.date.strftime('%d.%m.%Y') }}</p>
                        <p><strong>–ú–µ—Å—Ç–æ:</strong> {{ event.location }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>–û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä:</strong> {{ event.organizer.full_name }}</p>
                        <p><strong>–í–æ–ª–æ–Ω—Ç—ë—Ä—ã:</strong> {{ event.volunteers_count }}/{{ event.required_volunteers }}</p>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <a href="{{ url_for('index') }}" class="btn btn-secondary">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</a>
                
                {% if current_user.is_authenticated %}
                    {% if current_user.role.name in ['administrator', 'moderator'] %}
                        <a href="{{ url_for('edit_event', event_id=event.id) }}" class="btn btn-outline-primary">
                            ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                        </a>
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- –°–ø–∏—Å–æ–∫ –ø—Ä–∏–Ω—è—Ç—ã—Ö –≤–æ–ª–æ–Ω—Ç—ë—Ä–æ–≤ (–¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ –∏ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤) -->
{% if current_user.is_authenticated and current_user.role.name in ['administrator', 'moderator'] %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">‚úÖ –ü—Ä–∏–Ω—è—Ç—ã–µ –≤–æ–ª–æ–Ω—Ç—ë—Ä—ã</h5>
            </div>
            <div class="card-body">
                {% set accepted_volunteers = event.get_accepted_volunteers() %}
                {% if accepted_volunteers %}
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>–§–ò–û</th>
                                <th>–ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</th>
                                <th>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for registration in accepted_volunteers %}
                            <tr>
                                <td>{{ registration.volunteer.full_name }}</td>
                                <td>{{ registration.contact_info }}</td>
                                <td>{{ registration.registration_date.strftime('%d.%m.%Y %H:%M') }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted">–ù–µ—Ç –ø—Ä–∏–Ω—è—Ç—ã—Ö –≤–æ–ª–æ–Ω—Ç—ë—Ä–æ–≤</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- –°–ø–∏—Å–æ–∫ –æ–∂–∏–¥–∞—é—â–∏—Ö –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –¥–ª—è –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤) -->
{% if current_user.is_authenticated and current_user.role.name in ['administrator', 'moderator'] %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">‚è≥ –ó–∞—è–≤–∫–∏ –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏</h5>
            </div>
            <div class="card-body">
                {% set pending_volunteers = event.get_pending_volunteers() %}
                {% if pending_volunteers %}
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>–§–ò–û</th>
                                <th>–ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</th>
                                <th>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for registration in pending_volunteers %}
                            <tr>
                                <td>{{ registration.volunteer.full_name }}</td>
                                <td>{{ registration.contact_info }}</td>
                                <td>{{ registration.registration_date.strftime('%d.%m.%Y %H:%M') }}</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{{ url_for('accept_registration', event_id=event.id, registration_id=registration.id) }}" 
                                           class="btn btn-success" 
                                           onclick="return confirm('–ü—Ä–∏–Ω—è—Ç—å –∑–∞—è–≤–∫—É –æ—Ç {{ registration.volunteer.full_name }}?')">
                                            ‚úÖ –ü—Ä–∏–Ω—è—Ç—å
                                        </a>
                                        <a href="{{ url_for('reject_registration', event_id=event.id, registration_id=registration.id) }}" 
                                           class="btn btn-danger"
                                           onclick="return confirm('–û—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É –æ—Ç {{ registration.volunteer.full_name }}?')">
                                            ‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted">–ù–µ—Ç –∑–∞—è–≤–æ–∫, –æ–∂–∏–¥–∞—é—â–∏—Ö —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏—è</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- –ë–ª–æ–∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
{% if current_user.is_authenticated and current_user.role.name == 'user' %}
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">–ú–æ—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h5>
            </div>
            <div class="card-body">
                {% if user_registration %}
                    <!-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω -->
                    <div class="alert alert-info">
                        <h6>–°—Ç–∞—Ç—É—Å –≤–∞—à–µ–π –∑–∞—è–≤–∫–∏:</h6>
                        <p><strong>–î–∞—Ç–∞ –ø–æ–¥–∞—á–∏:</strong> {{ user_registration.registration_date.strftime('%d.%m.%Y %H:%M') }}</p>
                        <p><strong>–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:</strong> {{ user_registration.contact_info }}</p>
                        <p><strong>–°—Ç–∞—Ç—É—Å:</strong> 
                            <span class="badge {% if user_registration.status == 'accepted' %}bg-success{% elif user_registration.status == 'rejected' %}bg-danger{% else %}bg-warning{% endif %}">
                                {% if user_registration.status == 'accepted' %}–ü—Ä–∏–Ω—è—Ç–æ
                                {% elif user_registration.status == 'rejected' %}–û—Ç–∫–ª–æ–Ω–µ–Ω–æ
                                {% else %}–ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏{% endif %}
                            </span>
                        </p>
                    </div>
                {% elif event.is_registration_open %}
                    <!-- –ö–Ω–æ–ø–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
                    <button type="button" class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#registrationModal">
                        üìù –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ
                    </button>
                {% else %}
                    <div class="alert alert-warning">
                        <p class="mb-0">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–∞ —ç—Ç–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –∑–∞–∫—Ä—ã—Ç–∞</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
<div class="modal fade" id="registrationModal" tabindex="-1" aria-labelledby="registrationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="registrationModalLabel">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('register_for_event', event_id=event.id) }}">
                <div class="modal-body">
                    {{ form.hidden_tag() }}
                    <p>–í—ã —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç–µ—Å—å –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ: <strong>"{{ event.title }}"</strong></p>
                    
                    <div class="mb-3">
                        {{ form.contact_info.label(class="form-label") }}
                        {{ form.contact_info(class="form-control", placeholder="Email, —Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ –¥—Ä—É–≥–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã") }}
                        {% if form.contact_info.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.contact_info.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div class="form-text">–£–∫–∞–∂–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–≤—è–∑–∏ —Å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–æ–º</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    {{ form.submit(class="btn btn-primary") }}
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}